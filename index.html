<!DOCTYPE html>
<html>
<head>
    <title>Map Brain - mbn.im</title>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <!-- <link href="" rel="shortcut icon" /> -->
<style>

* {
  margin: 0;
  padding: 0;
  outline: 0;
  border: none;
}

html, body {
  width: 100%;
  height: 100%;
  min-width: 1024px;
  min-height: 800px;
  background: #484848;
}

.module {
  width: 100%;
  height: 512px;
  border-radius: 6px;
  box-shadow: 0 5px 12px rgba(0,0,0, .8);
  background: #fff;
  overflow: hidden;
}

#center {
  margin: 0 auto;
  width: 1024px;
}

#pool {
  font-size: 0;
}

#canvas {
  display: none;
}

</style>
</head>
<body>

  <div id="center">

    <iframe id="iframe" class="module" src="https://map.baidu.com/"></iframe>

    <div id="pool" class="module">
        
    </div>
  
    
    <button onclick="fetch()">Fetch</button>
    <button onclick="exportImg()">Export</button>
  
    <img id="export" class="module" src="" >
      
    <p>jisuowei.com</p>

    <canvas id="canvas" width="4096" height="2048" ></canvas>
      
  </div>

</body>
<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript">

    const UNIT_W = 512;
    const UNIT_H = 512;
    const pitchs = [-45, 0, 45, 90];
    const headings = [0, 90, 180, 270, 360];
    let srcs = [];

    for ( let i = 0, len = 4; i < len; i++ ) {
        for ( let _i = 0, _len = 8; _i < _len; _i ++ ) {
            srcs.push({
                row: i,
                col: _i,
                src: `https://mapsv1.bdimg.com/?qt=pdata&sid=09002900121705161534243787H&pos=${i}_${_i}&z=4`
            });
        }
    }

    function appendImg() {
        setTimeout( () => {
            const first = srcs.shift()
            if ( first ) {
                $('#pool').append(`<img crossOrigin="Anonymous" width="128" row="${first.row}" col="${first.col}" onload="appendImg()" src="${first.src}" />`)
            } else {
                drawImage()
            }
        }, 10)
    }

    function fetch() {
        appendImg()
    }



    function drawImage() {
        const ctx = document.querySelector('#canvas').getContext('2d')
        const images = document.querySelectorAll('#pool img');

        images.forEach( img => {
            const row = img.getAttribute('row')
            const col = img.getAttribute('col')
            // img.setAttribute("crossOrigin",'Anonymous')
            ctx.drawImage(img, UNIT_W * col, UNIT_H * row, UNIT_W, UNIT_H)
        })
    }

    function exportImg() {
        grab(document.querySelector('#canvas').toDataURL('image/jpg'))
    }


    function grab (base64, name = 'export.jpg') {
        // console.log(base64)
        $('#export').attr('src', base64)
        return
        const link = document.createElement('a')
        link.setAttribute('href', base64)
        link.setAttribute('download', name)
        link.dispatchEvent(new MouseEvent(`click`, { bubbles: true, cancelable: true, view: window }))
      }






</script>
</html>