<!DOCTYPE html>
<html>
<head>
    <title>Map Brain - mbn.im</title>
    <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1">
    <link href="./images/favicon.ico" rel="shortcut icon" />
<style>

* {
  margin: 0;
  padding: 0;
  outline: 0;
  border: none;
}

html, body {
  width: 100%;
  height: 100%;
  min-width: 1200px;
  min-height: 800px;
  background: #073042;
}

body {
  padding-top: 60px;
}

.center {
  margin: 0 auto;
  width: 1200px;
}

.blur {
  filter: blur(4px);
  opacity: .4;
}

.left {
  float: left;
}

.right {
  float: right;
}

.logo {
  width: 72px;
  height: 60px;
}

.navi {
  margin-left: 40px;
  font-weight: 300;
  font-size: 16px;
}

.github a,
.navi a {
  margin-left: 24px;
  cursor: pointer;
  color: rgba(255,255,255, .7);
}

.github a {
  font-size: 12px;
}

.navi a:hover {
  color: #fff;
}

.module {
  width: 100%;
  padding: 60px 0 120px 0;
  background: url(./images/line_bg.png) no-repeat center;
  background-size: 1920px;
}
.module.fetcher { background-color: #3ddc84; }
.module.viewer { background-color: #4285f4; }

.module .title {
  text-align: center;
  font-size: 32px;
  font-weight: 400;
  color: #fff;
}

.module .subtitle {
  margin: 6px 0 32px 0;
  text-align: center;
  font-size: 20px;
  font-weight: 200;
  color: rgba(255,255,255, .7);
}

.module .subtitle.-bottom {
  margin: 40px 0 0 0;
}

.header {
  position: fixed;
  z-index: 99;
  top: 0;
  width: 100%;
  height: 60px;
  line-height: 60px;
  color: #fff;
  background: #073042;
}

.steper {
  margin-bottom: 32px;
  text-align: center;
  color: #fff;
  font-size: 10px;
}

.steper .item {
  display: inline-block;
  border: 1px solid #fff;
  border-radius: 20px;
  padding: 2px 8px;
  font-size: 14px;
}

.steper span + span {
  margin-left: 12px;
}

.steper .item.active {
  color: #3ddc84;
  background: #fff;
}

.input-label {
  display: inline-block;
  margin: 8px 0 4px 4px;
  font-size: 12px;
  color: #999;
}

.input {
  box-sizing: border-box;
  border: 1px solid #ddd;
  width: 100%;
  padding: 6px 12px;
  height: 38px;
  line-height: 38px;
  border-radius: 4px;
  font-family: monospace, consolas;
}

.input[readonly] {
  color: #aaa;
  border-color: #eee;
  background: #fafafa;
}

.input.active {
  border-color: #3ddc84;
}

.input.error {
  border-color: #f86734;
}

.radio-group {
  display: flex;
  box-sizing: border-box;
  border: 1px solid #3ddc84;
  width: 100%;
  height: 38px;
  line-height: 36px;
  border-radius: 4px;
  font-family: monospace, consolas;
}

.radio-group .group-item {
  width: 50%;
  text-align: center;
  color: #3ddc84;
  font-size: 14px;
  cursor: pointer;
}

.radio-group .group-item.active {
  color: #fff;
  background: #3ddc84;
}

.btn {
  display: block;
  position: absolute;
  bottom: 0;
  width: 100%;
  background-image: -webkit-linear-gradient(0deg, #3ddc84,#4285f4);
  text-align: center;
  color: #fff;
  height: 48px;
  line-height: 48px;
  font-size: 18px;
  text-decoration: none;
  font-weight: 300;
  border-radius: 4px;
  user-select: none;
}

.btn:not(.disabled) {
  animation: wave linear 1s infinite alternate;
}

@keyframes wave {
  from {
    background: #4285f4;
  }
  to {
    background: #3ddc84;
  }
}
.btn.disabled {
  filter: grayscale(90%);
}

.btn:hover {
  cursor: pointer;
  opacity: .9;
}

.btn.disabled:hover {
  cursor: not-allowed;
  opacity: 1;
}

.wave {
  font-size: 0;
  height: 200px;
  overflow: hidden;
  background: url(./images/wave-blue.svg) no-repeat center top;
  background-size: 2560px;
  background-color: #3ddc84;
}

.footer {
  width: 100%;
  height: 100px;
  line-height: 100px;
  font-weight: 300;
  padding-bottom: 40px;
}

.footer p {
  color: #fff;
  font-size: 14px;
  text-align: center;
}

.footer p a {
  color: #fff;
}

.choose-view-container {
  position: relative;
}

.choose-view {
  border: 4px solid #fff;
  height: 560px;
  box-sizing: border-box;
  box-sizing: #348a5b;
  background: #fff;
  box-shadow: 0 10px 30px rgba(10,30,60, .3);
  transition: all .5s;
  border-radius: 6px;
}

.choose-view .map {
  float: left;
  width: 788px;
  height: 552px;
  border-radius: 4px;
}

.choose-view .view-console {
  float: right;
  position: relative;
  width: 400px;
  height: 100%;
}

.choose-view .view-console .console-top {
  position: relative;
  width: 400px;
  height: 200px;
  font-size: 0;
  border-radius: 4px;
  background: url(./images/thumbnail.png) no-repeat center;;
  overflow: hidden;
}

.choose-view .view-console .console-top::before,
.choose-view .view-console .console-top::after {
  content: 'üëà Choose a view by';
  display: inline-block;
  position: absolute;
  z-index: 9;
  top: 80px;
  right: 20px;
  left: 20px;
  font-size: 18px;
  text-align: center;
  color: #666;
  font-weight: 300;
}
.choose-view .view-console .console-top::before {
  top: 120px;
  content: 'clicking blue line on the map left';
}

.choose-view .view-console #view-thumbnail {
  display: none;
  position: absolute;
  z-index: 10;
  width: 400px;
  height: 200px;
  border-radius: 4px;
}

#loading {
  display: none;
  position: absolute;
  z-index: 10;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  text-align: center;
  line-height: 552px;
  font-size: 60px;
  background: rgba(61,220,132, .3);
  user-select: none;
}

#fetch-pool {
  display: none;
  position: absolute;
  z-index: 9;
  top: 20px;
  left: 88px;
  width: 1024px;
  height: 512px;
  background: #fff;
  box-shadow: 0 10px 50px rgba(0,0,0, .2);
  outline: 4px solid #fff;
  font-size: 0;
  user-select: none;
}

#fetch-pool::before {
  content: '';
  display: block;
  position: absolute;
  z-index: 10;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  background: rgba(255,255,255, .3);
}

#fetch-pool::after {
  content: '';
  display: block;
  position: absolute;
  z-index: 8;
  top: -20px;
  right: -88px;
  bottom: -20px;
  left: -88px;
  /* background: rgba(0,0,0, .2); */
}

#fetch-pool.done::before {
  display: none;
}

#fetch-close,
#fetch-status {
  position: absolute;
  z-index: -2;
  top: 0;
  left: -4px;
  width: 100px;
  height: 28px;
  line-height: 28px;
  background: #fff;
  text-align: center;
  border-top-right-radius: 4px;
  border-top-left-radius: 4px;
  font-size: 12px;
  color: #666;
  transition: all .23s;
}

#fetch-close {
  left: auto;
  right: -4px;
  cursor: pointer;
  color: #4285f4;
}

#fetch-close:hover {
  color: #348a5b;
}

#fetch-close.show,
#fetch-status.show {
  top: -28px;
  z-index: 10;
}

#export-bg {
  position: absolute;
  z-index: -1;
  width: 100%;
  height: 100%;
  font-size: 24px;
  color: #ddd;
  border-collapse: collapse;
}

#export-bg td {
  border: 1px solid #efefef;
  text-align: right;
  vertical-align: bottom;
  width: 12.5%;
  font-family: monospace, consolas;
  background: #fff;
}

#export {
  position: absolute;
  z-index: 10;
  display: none;
  width: 100%;
  height: 100%;
}

#canvas {
  display: none;
}

.anchorBL {
  display: none;
}


.drop-view {
  border: 2px dashed #fff;
  height: 560px;
  box-sizing: border-box;
  box-sizing: #348a5b;
  border-radius: 6px;
  line-height: 560px;
  text-align: center;
  font-size: 48px;
  font-weight: 100;
  color: #fff;
  user-select: none;
  background: rgba(255,255,255, .1);
}

#mask {
  display: none;
  position: fixed;
  z-index: 100;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  padding: 6rem 2rem;
  background: #f86734;
  opacity: .9;
  color: #fff;
  font-size: 3rem;
  text-align: center;
  line-height: 4rem;
}

@media (max-width: 768px) {
  #mask {
    display: block;
  }
}

</style>
</head>
<body>

  <div id="mask">
    ËØ∑Âú®PCÁ´ØÊµèËßàÂô®Âú∞ÂùÄÊ†è‰∏≠ËæìÂÖ• mbn.im ËÆøÈóÆ
  </div>

  <div class="header">
    <div class="center">
      <div class="left">
        <img class="logo" src="./images/logo.png">
      </div>
      <div class="left navi">
        <a>Fetcher</a>
        <a>Viewer</a>
      </div>
      <div class="right github">
        <a href="https://www.bilibili.com/video/av67624282/" target="_blank">DemoVideo</a>
        <a href="https://github.com/Chisw/MapBrain" target="_blank">GitHub</a>
      </div>
    </div>
  </div>

  <div class="module fetcher">
    <div class="center">

      <h3 class="title">Fetcher</h3>
      <h4 class="subtitle">3 steps get your panoramic image</h4>

      <div class="steper">
        <span class="item active">1. Choose view</span>
        <span>‚ñ∂</span>
        <span class="item">2. Fetch data</span>
        <span>‚ñ∂</span>
        <span class="item">3. Save image</span>
      </div>

      <div class="choose-view-container">

        <div class="choose-view" id="choose-view">

          <div class="map" id="map"></div>

          <div class="view-console">
            <div class="console-top">
              <img id="view-thumbnail" src="" />
            </div>
            <div class="console-bottom">
                <label class="input-label">Pano id</label>
                <input id="pano-id" class="input" readonly>
                <label class="input-label">Pano position</label>
                <input id="pano-posi" class="input" readonly>
                <label class="input-label">Customize pano id</label>
                <input id="pano-id-user" class="input" placeholder="Paste pano_id here if you have" maxlength="27">
                <label class="input-label">Image type</label>
                <div class="radio-group">
                  <span data-type="jpeg" class="group-item active">.jpeg</span>
                  <span data-type="png" class="group-item">.png</span>
                </div>
                <span id="btn-fetch" class="btn disabled">Fetch</span>
            </div>
          </div><!-- .view-console -->
        </div><!-- .choose-view -->

        <div id="loading">üïí</div>

        <div id="fetch-pool">
          <div id="fetch-status">Fetching ..</div>
          <div id="fetch-close">Close</div>
          <table id="export-bg">
            <tr><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td></tr>
            <tr><td>9</td><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td></tr>
            <tr><td>17</td><td>18</td><td>19</td><td>20</td><td>21</td><td>22</td><td>23</td><td>24</td></tr>
            <tr><td>25</td><td>16</td><td>27</td><td>28</td><td>29</td><td>30</td><td>31</td><td>32</td></tr>
          </table>
          <img id="export" alt="export" src="" >
        </div>

      </div>
      <h4 class="subtitle -bottom">The size of the generated image may be over 5M, <br>which is why we use manual 'Save' instead of automatic 'Export'.</h4>
    </div>
  </div>

  <div class="wave"></div>

  <div class="module viewer">
    <div class="center">
      <h3 class="title">Viewer</h3>
      <h4 class="subtitle">View your panoramic image online or download Viewer.zip for offline using</h4>

      <div class="drop-view">
        Coming soon
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="center">
      <p>(„Å•‚Ä≤‚ñΩ`)„Å•&emsp;Any suggestions or bugs send email to <a href="mailto:i@jisuowei.com">i@jisuowei.com</a></p>
    </div>
  </div>

  <canvas id="canvas" width="4096" height="2048" ></canvas>

</body>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=hWlAC3G3AFjWt3QGjB5o7eK4HIqzMhQZ"></script>
<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript">
(function() {

  const MapBrain = {

    init() {
      this.initMap();
      this.initEvent();
    },

    map: null,
    units: [],
    pano_id: '',
    pano_id_user: '',
    PANO_ID_RE: /^[0-9]{26}[A-Z]{1}$/,

    initMap() {
      const map = new BMap.Map('map', {enableMapClick: false});
      map.centerAndZoom(new BMap.Point(120.616675, 31.338262), 14);
      map.enableScrollWheelZoom(true);
      
      map.addTileLayer(new BMap.PanoramaCoverageLayer());  // Ë¶ÜÁõñÂå∫ÂüüÂõæÂ±ÇÊµãËØï

      // const stCtrl = new BMap.PanoramaControl(); //ÊûÑÈÄ†ÂÖ®ÊôØÊéß‰ª∂
      // stCtrl.setOffset(new BMap.Size(20, 20));
      // map.addControl(stCtrl);//Ê∑ªÂä†ÂÖ®ÊôØÊéß‰ª∂

      const navigationControl = new BMap.NavigationControl({
        anchor: BMAP_ANCHOR_TOP_LEFT,
        type: BMAP_NAVIGATION_CONTROL_LARGE,
      });

      map.addControl(navigationControl);

      map.addEventListener('click', (event) => {
        $('#pano-id-user').val('').trigger('input').blur();
        this.pano_id_user = '';
        this.getPanoID(event.point);
      })
      this.map = map;
    },  // initMap

    initEvent() {
      $('body')
        .on('click', '.navi a', function() {
          const index = $(this).index();
          $('html, body').animate({scrollTop: [20, 1220][index] }, 230);
        })
        .on('click', '.radio-group .group-item', function() {
          $(this).addClass('active').siblings().removeClass('active');
        })
        .on('click', '#btn-fetch', () => {
          if ( !$('#btn-fetch').hasClass('disabled') ) {
            this.fetch();
          }
        })
        .on('input properychange', '#pano-id-user', () => {
          const $u = $('#pano-id-user');
          const id = $u.val();

          if ( id === '') {
            $u.removeClass('error active');
            this.pano_id_user = '';
          } else if ( this.PANO_ID_RE.test(id) ) {
            $u.removeClass('error').addClass('active');
            this.pano_id_user = id;
            this.setThumbnail(id);

            $('#pano-id, #pano-posi').val('');
            this.pano_id = '';
          } else {
            $u.removeClass('active').addClass('error');
            this.pano_id_user = '';
          }

          this.switchBtn();
        })
        .on('click', '#fetch-close', () => {
          this.reset();
        })
    },  // initEvent

    stepTo(index) {
      $(`.steper .item:nth(${index})`).addClass('active').siblings().removeClass('active');
    },  // stepTo

    setThumbnail(id) {
      if ( id ) {
        this.loading();
        $('#view-thumbnail').attr('src', `https://mapsv1.bdimg.com/?qt=pdata&sid=${id}&pos=0_0&z=1`).show();
        this.loaded();
      } else {
        $('#view-thumbnail').attr('src', ``).hide();
      }
    },

    switchBtn() {
      if ( this.pano_id || this.pano_id_user ) {
        $('#btn-fetch').removeClass('disabled');
      } else {
        $('#btn-fetch').addClass('disabled');
      }
    },

    getPanoID(point) {
      this.loading();

      const { lng, lat } = point;

      const panoramaService = new BMap.PanoramaService();
      panoramaService.getPanoramaByLocation(new BMap.Point(lng, lat), (data) => {
        this.map.clearOverlays();
        if (data !== null) {
          $('#pano-id').val(data.id);
          $('#pano-posi').val(data.position.lng + ',' + data.position.lat);
          this.setThumbnail(data.id);
          this.pano_id = data.id;

          const point = new BMap.Point(data.position.lng, data.position.lat);
          this.map.panTo(point);
          const marker = new BMap.Marker(point);  // ÂàõÂª∫Ê†áÊ≥®
          this.map.addOverlay(marker);               // Â∞ÜÊ†áÊ≥®Ê∑ªÂä†Âà∞Âú∞Âõæ‰∏≠
          marker.setAnimation(BMAP_ANIMATION_BOUNCE); //Ë∑≥Âä®ÁöÑÂä®Áîª
        } else {
          $('#pano-id').val('NO_MATCHED_POINT');
          $('#pano-posi').val('TRY_AGAIN');
          this.setThumbnail();
          this.pano_id = '';
        }
        this.loaded();
        this.switchBtn();
      });
    },  // getPanoID

    fetch() {
      $('#choose-view').addClass('blur');
      this.stepTo(1);

      setTimeout(() => {
        $('#fetch-pool').fadeIn();

        setTimeout(() => {
          $('#fetch-status').addClass('show');
        }, 500);

        let units = [];

        for ( let row = 0, rows = 4; row < rows; row++ ) {
          for ( let col = 0, cols = 8; col < cols; col ++ ) {
            units.push({
              row,
              col,
              src: `https://mapsv1.bdimg.com/?qt=pdata&sid=${ this.pano_id_user || this.pano_id }&pos=${row}_${col}&z=4`
            });
          }
        }

        this.units = units;
        this._appendImg()
      }, 501)
    },  // fetch

    _appendImg() {
      setTimeout( () => {
        const first = this.units.shift()
        if ( first ) {
          $('#fetch-pool').append(
            `<img 
              class="unit"
              crossOrigin="Anonymous" 
              width="128" 
              row="${first.row}" 
              col="${first.col}" 
              onload="MapBrain._appendImg()" 
              src="${first.src}" 
            />`
          )
        } else {
          this.drawCanvas();
        }
      }, 10)
    },  // _appendImg

    drawCanvas() {
      const ctx = document.querySelector('#canvas').getContext('2d');
      const images = document.querySelectorAll('#fetch-pool .unit');

      images.forEach( img => {
        const row = img.getAttribute('row');
        const col = img.getAttribute('col');
        ctx.drawImage(img, 512 * col, 512 * row, 512, 512);
      })

      $('#fetch-status').text('Drawing ..');

      setTimeout(() => {
        const base64 = document.querySelector('#canvas').toDataURL(`image/${$('.group-item.active').data('type')}`);
        $('#export').attr('src', base64).show();
        $('#fetch-pool').addClass('done');
        
        this.stepTo(2);

        $('#fetch-status').text('Done');
        setTimeout(() => {
          $('#fetch-status').removeClass('show');
          $('#fetch-close').addClass('show');
        }, 2000);


      }, 20);
    },  // drawCanvas

    loading() {
      $('#loading').fadeIn();
    },

    loaded() {
      $('#loading').fadeOut();
    },
    
    reset() {
      $('#fetch-pool').fadeOut().removeClass('done');
      $('#fetch-pool .unit').remove();
      $('#choose-view').removeClass('blur');
      $('#pano-id').val('');
      $('#pano-posi').val('');
      this.pano_id = '';
      this.pano_id_user = '';
      $('#btn-fetch').addClass('disabled');
      $('#fetch-status').text('Fetching').removeClass('show');
      $('#fetch-close').removeClass('show');
      $('#export').hide();
      this.setThumbnail();
      this.stepTo(0);
    },

  };

  window.MapBrain = MapBrain;

  MapBrain.init();

} ());
</script>
</html>